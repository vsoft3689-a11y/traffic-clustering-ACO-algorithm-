<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Traffic Data Clustering System Using ACO Algorithm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f9fafb; }
        h1 { color: #2c3e50; }
        canvas { background: #fff; border-radius: 10px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="p-4">
<div class="container">
    <h1 class="mb-3">Traffic Data Clustering System Using ACO Algorithm</h1>

    <div class="mb-3">
        <label class="form-label">Upload CSV (lat,lon,speed,timestamp,city,density)</label>
        <input type="file" id="csvFile" class="form-control" accept=".csv">
        <button id="uploadBtn" class="btn btn-primary mt-2">Upload CSV</button>
    </div>

    <div class="mb-3">
        <button id="refreshBtn" class="btn btn-success">Refresh</button>
    </div>

    <div class="row">
        <div class="col-md-6">
            <canvas id="scatterChart" width="400" height="400"></canvas>
        </div>
        <div class="col-md-6">
            <canvas id="barChart" width="400" height="400"></canvas>
        </div>
    </div>
</div>

<script>
    const uploadBtn = document.getElementById('uploadBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const csvFile = document.getElementById('csvFile');
    let scatterChart, barChart;

    /**
     * Draw scatter and bar charts from clusters data
     */
    function drawCharts(data){
      // Ensure clusters is always an array
      let clusters = Array.isArray(data.clusters) ? data.clusters : [];

      const datasets = clusters.map((c, idx) => {
        const members = Array.isArray(c.members) ? c.members : [];
        return {
          label: 'Cluster ' + idx,
          data: members.map(m => ({x: m.lon, y: m.lat, speed: m.speed})),
          backgroundColor: c.color,
          borderColor: c.color,
          pointRadius: 6
        };
      });

      // Scatter chart
      const ctx = document.getElementById('scatterChart').getContext('2d');
      if (scatterChart) scatterChart.destroy();
      scatterChart = new Chart(ctx, {
        type: 'scatter',
        data: { datasets },
        options: {
          plugins: { legend: { display: true } },
          scales: {
            x: { title: { display:true, text:'Longitude' } },
            y: { title: { display:true, text:'Latitude' } }
          }
        }
      });

      // Bar chart
      const labels = clusters.map((c,i) => 'C' + i);
      const counts = clusters.map(c => Array.isArray(c.members) ? c.members.length : 0);
      const colors = clusters.map(c => c.color || '#000');

      const ctx2 = document.getElementById('barChart').getContext('2d');
      if (barChart) barChart.destroy();
      barChart = new Chart(ctx2, {
        type:'bar',
        data: { labels, datasets: [{ label: 'Points', data: counts, backgroundColor: colors, borderColor: colors }] },
        options: {}
      });
    }

    // CSV upload handler
    uploadBtn.addEventListener('click', async () => {
      if (!csvFile.files.length) return alert('Choose a CSV first');
      const f = csvFile.files[0];
      const fd = new FormData();
      fd.append('file', f);

      uploadBtn.disabled = true;
      try {
        const res = await fetch('/upload-csv', { method:'POST', body: fd });
        const j = await res.json();
        if (j.status === 'ok') {
          drawCharts(j); // pass full response with points + clusters
        } else {
          alert('Upload failed: ' + JSON.stringify(j));
        }
      } catch(err) {
        console.error(err);
        alert('Upload error: ' + err.message);
      } finally {
        uploadBtn.disabled = false;
      }
    });

    // Refresh random points handler
    refreshBtn.addEventListener('click', async () => {
      refreshBtn.disabled = true;
      try {
        const r = await fetch('/refresh-random?count=80');
        const j = await r.json();
        drawCharts(j);
      } catch(err) {
        console.error(err);
        alert('Refresh error: ' + err.message);
      } finally {
        refreshBtn.disabled = false;
      }
    });
</script>
</body>
</html>
